// ‡πÑ‡∏ü‡∏•‡πå: /src/scripts/authService.js
// Authentication Service - ‡∏£‡∏ß‡∏° Register, Login, Logout ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Login History

import { auth, db } from './firebase-config.js';
import { 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    signOut,
    sendPasswordResetEmail,
    onAuthStateChanged,
    updateProfile
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // *** FIXED VERSION ***
import { 
    doc, 
    setDoc,
    getDoc,
    collection,
    addDoc,
    serverTimestamp,
    updateDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // *** FIXED VERSION ***

// ===========================
// Helper Functions
// ===========================

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Login History ‡∏•‡∏á Firestore
 */
async function logLoginHistory(userId, email, success = true, errorMessage = null, loginMethod = 'email') {
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á db ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Firestore functions
        if (!db) {
             console.error('‚ùå Firestore instance (db) is undefined. Skipping login history.');
             return { success: false, error: 'Firestore not initialized.' };
        }
        
        const loginData = {
            userId: userId || 'unknown',
            email: email,
            success: success,
            loginMethod: loginMethod, // 'email' ‡∏´‡∏£‡∏∑‡∏≠ 'google'
            timestamp: serverTimestamp(),
            
            // Device & Browser Info
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            
            // Browser Details
            browser: getBrowserInfo(),
            os: getOSInfo(),
            
            // Page Info
            referrer: document.referrer || 'direct',
            currentUrl: window.location.href
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° error message ‡∏ñ‡πâ‡∏≤ login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if (!success && errorMessage) {
            loginData.errorMessage = errorMessage;
            loginData.errorCode = errorMessage;
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á collection "loginHistory"
        const historyRef = await addDoc(collection(db, 'loginHistory'), loginData);
        console.log('‚úÖ Login history recorded:', historyRef.id);
        
        // ‡∏ñ‡πâ‡∏≤ login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó lastLogin ‡πÉ‡∏ô user document
        if (success && userId) {
            const userRef = doc(db, 'users', userId);
            await updateDoc(userRef, {
                lastLogin: serverTimestamp(),
                lastLoginMethod: loginMethod,
                lastLoginDevice: navigator.userAgent,
                lastLoginBrowser: getBrowserInfo(),
                lastLoginOS: getOSInfo()
            });
            console.log('‚úÖ User lastLogin updated');
        }
        
        return { success: true, historyId: historyRef.id };
        
    } catch (error) {
        console.error('‚ùå Error logging login history:', error);
        return { success: false, error: error.message };
    }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Browser
 */
function getBrowserInfo() {
    const userAgent = navigator.userAgent;
    let browser = "Unknown";
    
    if (userAgent.indexOf("Chrome") > -1) {
        browser = "Chrome";
    } else if (userAgent.indexOf("Safari") > -1) {
        browser = "Safari";
    } else if (userAgent.indexOf("Firefox") > -1) {
        browser = "Firefox";
    } else if (userAgent.indexOf("MSIE") > -1 || userAgent.indexOf("Trident") > -1) {
        browser = "Internet Explorer";
    } else if (userAgent.indexOf("Edge") > -1) {
        browser = "Edge";
    }
    
    return browser;
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Operating System
 */
function getOSInfo() {
    const userAgent = navigator.userAgent;
    let os = "Unknown";
    
    if (userAgent.indexOf("Win") > -1) {
        os = "Windows";
    } else if (userAgent.indexOf("Mac") > -1) {
        os = "MacOS";
    } else if (userAgent.indexOf("Linux") > -1) {
        os = "Linux";
    } else if (userAgent.indexOf("Android") > -1) {
        os = "Android";
    } else if (userAgent.indexOf("iOS") > -1 || userAgent.indexOf("iPhone") > -1 || userAgent.indexOf("iPad") > -1) {
        os = "iOS";
    }
    
    return os;
}

// ===========================
// Authentication Functions
// ===========================

/**
 * Register with Email/Password
 */
export async function registerUser(userData) {
    try {
        console.log('üìù Registering user:', userData.email);
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏ô Firebase Authentication
        const userCredential = await createUserWithEmailAndPassword(
            auth,
            userData.email,
            userData.password
        );
        
        const user = userCredential.user;
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Display Name
        await updateProfile(user, {
            displayName: userData.name
        });
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore
        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            name: userData.name,
            email: userData.email,
            phone: userData.phone,
            birthday: userData.birthday,
            gender: userData.gender,
            address: userData.address,
            createdAt: serverTimestamp(),
            lastLogin: serverTimestamp(),
            provider: 'email',
            termsAccepted: userData.terms,
            emailVerified: user.emailVerified,
            role: 'customer'
        });
        
        console.log('‚úÖ User registered successfully:', user.uid);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Registration History
        await logLoginHistory(user.uid, userData.email, true, null, 'email-register');
        
        return {
            success: true,
            user: user,
            message: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'
        };
        
    } catch (error) {
        console.error("‚ùå Registration error:", error);
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        
        switch(error.code) {
            case 'auth/email-already-in-use':
                errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                break;
            case 'auth/invalid-email':
                errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                break;
            case 'auth/weak-password':
                errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                break;
            case 'auth/network-request-failed':
                errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                break;
        }
        
        return {
            success: false,
            error: error,
            message: errorMessage
        };
    }
}

/**
 * Register with Google
 */
export async function registerWithGoogle() {
    try {
        console.log('üîê Google Sign-in initiated');
        
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        
        console.log('‚úÖ Google Sign-in successful:', user.email);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const isNewUser = !userDoc.exists();
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore
        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            name: user.displayName,
            email: user.email,
            phone: '',
            birthday: '',
            gender: '',
            address: '',
            createdAt: isNewUser ? serverTimestamp() : userDoc.data().createdAt,
            lastLogin: serverTimestamp(),
            provider: 'google',
            photoURL: user.photoURL,
            emailVerified: user.emailVerified,
            role: userDoc.exists() ? userDoc.data().role : 'customer'
        }, { merge: true });
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Login History
        await logLoginHistory(
            user.uid, 
            user.email, 
            true, 
            null, 
            isNewUser ? 'google-register' : 'google-login'
        );
        
        return {
            success: true,
            user: user,
            isNewUser: isNewUser,
            message: isNewUser ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'
        };
        
    } catch (error) {
        console.error("‚ùå Google sign-in error:", error);
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google';
        
        if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        }
        
        return {
            success: false,
            error: error,
            message: errorMessage
        };
    }
}

/**
 * Sign In with Email and Password
 */
export async function signIn(email, password) {
    try {
        console.log('üîê Sign in attempt for:', email);
        
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log('‚úÖ Sign in successful:', user.uid);
        
        // Get user data from Firestore
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.exists() ? userDoc.data() : null;
        
        console.log('üìÑ User data retrieved:', userData);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Login History - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        await logLoginHistory(user.uid, email, true, null, 'email-login');
        
        return {
            success: true,
            user: user,
            userData: userData
        };
        
    } catch (error) {
        console.error("‚ùå Sign in error:", error.code, error.message);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Login History - ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        await logLoginHistory(null, email, false, error.code, 'email-login');
        
        return {
            success: false,
            error: error.code,
            message: error.message
        };
    }
}

/**
 * Sign Out
 */
export async function signOutUser() {
    try {
        const user = auth.currentUser;
        const userEmail = user ? user.email : 'unknown';
        
        console.log('üö™ Signing out user:', userEmail);
        
        await signOut(auth);
        
        console.log('‚úÖ Sign out successful');
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Logout History
        if (user) {
            await addDoc(collection(db, 'loginHistory'), {
                userId: user.uid,
                email: userEmail,
                success: true,
                loginMethod: 'logout',
                timestamp: serverTimestamp(),
                userAgent: navigator.userAgent,
                platform: navigator.platform
            });
        }
        
        return { success: true };
        
    } catch (error) {
        console.error("‚ùå Sign out error:", error);
        return {
            success: false,
            error: error.code,
            message: error.message
        };
    }
}

/**
 * Reset Password
 */
export async function resetPassword(email) {
    try {
        console.log('üìß Sending password reset email to:', email);
        
        await sendPasswordResetEmail(auth, email);
        
        console.log('‚úÖ Password reset email sent');
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Password Reset Request
        await addDoc(collection(db, 'loginHistory'), {
            email: email,
            success: true,
            loginMethod: 'password-reset-request',
            timestamp: serverTimestamp(),
            userAgent: navigator.userAgent
        });
        
        return { success: true };
        
    } catch (error) {
        console.error("‚ùå Reset password error:", error);
        return {
            success: false,
            error: error.code,
            message: error.message
        };
    }
}

/**
 * Get Current User
 */
export function getCurrentUser() {
    return auth.currentUser;
}

/**
 * Get User Data from Firestore
 */
export async function getUserData(uid) {
    try {
        const userDoc = await getDoc(doc(db, "users", uid));
        if (userDoc.exists()) {
            return {
                success: true,
                data: userDoc.data()
            };
        } else {
            return {
                success: false,
                error: "User data not found"
            };
        }
    } catch (error) {
        console.error("‚ùå Get user data error:", error);
        return {
            success: false,
            error: error.code,
            message: error.message
        };
    }
}

/**
 * Auth State Observer
 */
export function onAuthChange(callback) {
    return onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in
            const userData = await getUserData(user.uid);
            callback(user, userData.success ? userData.data : null);
        } else {
            // User is signed out
            callback(null, null);
        }
    });
}

/**
 * Check if user is authenticated
 */
export function isAuthenticated() {
    return new Promise((resolve) => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            resolve(!!user);
        });
    });
}

// Export auth and db for direct access if needed
export { auth, db };


